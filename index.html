<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no" />
  <meta name="theme-color" content="#0b1020" />
  <title>TAP TYCOON ‚Äî Mobile Clicker</title>
  <style>
    :root{
      --bg0:#060914; --bg1:#0b1020;
      --stroke: rgba(255,255,255,.14);
      --txt: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.65);
      --shadow: rgba(0,0,0,.45);

      --sheetClosed: min(220px, 30vh);
      --sheetOpen: min(520px, 62vh);
      --sheetRadius: 22px;
    }
    html,body{
      margin:0; height:100%; overflow:hidden;
      background:
        radial-gradient(1100px 700px at 20% 10%, rgba(120,140,255,.22), transparent 60%),
        radial-gradient(900px 600px at 80% 25%, rgba(255,120,220,.18), transparent 55%),
        linear-gradient(180deg,var(--bg1),var(--bg0));
      color:var(--txt);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      user-select:none;
    }

    /* Top HUD */
    #hud{
      position:fixed; left:0; right:0; top:0;
      padding: max(12px, env(safe-area-inset-top)) 12px 10px;
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      pointer-events:none;
      z-index:10;
    }
    .pill{
      pointer-events:auto;
      display:flex; align-items:baseline; gap:10px;
      padding:10px 12px;
      border-radius:999px;
      background: linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.06));
      border:1px solid var(--stroke);
      box-shadow: 0 16px 55px var(--shadow);
      backdrop-filter: blur(12px);
      font-weight:950;
      letter-spacing:.2px;
      white-space:nowrap;
    }
    .pill small{ color:var(--muted); font-weight:850; }
    .btn{
      pointer-events:auto;
      border:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(255,255,255,.14), rgba(255,255,255,.08));
      color:var(--txt);
      border-radius:999px;
      padding:10px 12px;
      font-weight:1000;
      letter-spacing:.2px;
      box-shadow: 0 16px 55px var(--shadow);
      backdrop-filter: blur(10px);
    }
    .btn:active{ transform: scale(.98); }

    /* Main area always visible above sheet */
    #main{
      position:fixed;
      inset:0;
      padding:
        calc(max(12px, env(safe-area-inset-top)) + 70px)
        14px
        calc(max(12px, env(safe-area-inset-bottom)) + var(--sheetClosed) + 12px)
        14px;
      display:flex;
      align-items:center;
      justify-content:center;
      flex-direction:column;
      gap:12px;
      z-index:1;
    }

    /* Big tap button (scales with screen) */
    #tapBtn{
      width: min(320px, 78vw);
      height: min(320px, 78vw);
      max-height: min(320px, 36vh); /* keeps it visible on short screens */
      max-width: min(320px, 36vh);
      aspect-ratio:1/1;
      border-radius:999px;
      border: 1px solid rgba(255,255,255,.18);
      background:
        radial-gradient(circle at 30% 25%, rgba(255,255,255,.18), transparent 45%),
        linear-gradient(135deg, rgba(116,216,255,.95), rgba(255,109,246,.90));
      box-shadow:
        0 22px 90px rgba(0,0,0,.55),
        0 0 45px rgba(116,216,255,.25);
      display:flex; align-items:center; justify-content:center;
      font-weight:1000;
      letter-spacing:.4px;
      cursor:pointer;
      transform: translateZ(0);
      transition: transform .08s ease, filter .10s ease;
      position:relative;
    }
    #tapBtn:active{ transform: scale(.98); filter: brightness(1.06); }
    #tapBtn .label{ text-align:center; line-height:1.05; text-shadow: 0 10px 30px rgba(0,0,0,.35); }
    #tapBtn .label .big{ font-size: clamp(26px, 7vw, 44px); }
    #tapBtn .label .small{
      margin-top:8px; font-size: 14px;
      font-weight:900; color: rgba(255,255,255,.86);
    }
    #tapBtn::after{
      content:"";
      position:absolute; inset:-18px;
      border-radius:999px;
      border: 2px solid rgba(255,255,255,.10);
      box-shadow: 0 0 40px rgba(255,109,246,.18);
      opacity:.0;
      animation: pulse 1.8s ease-in-out infinite;
    }
    @keyframes pulse{
      0%{ transform: scale(.96); opacity:.0; }
      35%{ opacity:.25; }
      70%{ transform: scale(1.06); opacity:.05; }
      100%{ transform: scale(1.08); opacity:0; }
    }

    .statsLine{
      display:flex; gap:10px; flex-wrap:wrap; justify-content:center;
      color:var(--muted); font-weight:900; text-align:center;
      max-width: 560px;
    }
    .statsLine b{ color:var(--txt); }

    /* Toasts */
    #toasts{
      position:fixed; left:50%; transform:translateX(-50%);
      top: calc(max(12px, env(safe-area-inset-top)) + 68px);
      display:flex; flex-direction:column; gap:8px;
      pointer-events:none;
      z-index:50;
    }
    .toast{
      padding:10px 12px;
      border-radius:999px;
      background: rgba(16,20,40,.72);
      border:1px solid rgba(255,255,255,.14);
      box-shadow:0 18px 70px rgba(0,0,0,.45);
      backdrop-filter: blur(12px);
      font-weight:1000;
      opacity:0;
      transform: translateY(-8px) scale(.98);
      animation: tin .22s ease forwards, tout .22s ease forwards;
      animation-delay: 0ms, 1500ms;
      max-width: min(92vw, 520px);
      text-align:center;
    }
    .toast small{ color:var(--muted); font-weight:900; }
    @keyframes tin{ to{opacity:1; transform: translateY(0) scale(1);} }
    @keyframes tout{ to{opacity:0; transform: translateY(-10px) scale(.98);} }

    /* Bottom sheet shop */
    #sheet{
      position:fixed; left:0; right:0; bottom:0;
      height: var(--sheetClosed);
      border-radius: var(--sheetRadius) var(--sheetRadius) 0 0;
      background: linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.07));
      border-top: 1px solid rgba(255,255,255,.14);
      box-shadow: 0 -16px 80px rgba(0,0,0,.45);
      backdrop-filter: blur(14px);
      z-index:20;
      overflow:hidden;
      transition: height .18s ease;
    }
    #sheet.open{ height: var(--sheetOpen); }

    #sheetHeader{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding: 10px 12px;
      border-bottom: 1px solid rgba(255,255,255,.10);
    }
    #handle{
      width: 54px; height: 6px; border-radius:999px;
      background: rgba(255,255,255,.20);
      margin: 0 auto;
    }
    #sheetTitle{
      display:flex; align-items:center; gap:10px;
      font-weight:1000; letter-spacing:.2px;
    }
    #sheetHint{ color:var(--muted); font-weight:900; font-size:12px; }

    #sheetBody{
      height: calc(100% - 52px);
      overflow:auto; /* IMPORTANT: scroll upgrades */
      padding: 10px 12px calc(max(12px, env(safe-area-inset-bottom)) + 14px);
      -webkit-overflow-scrolling: touch;
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
    }
    .card{
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      border-radius:18px;
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .name{ font-weight:1000; }
    .desc{ color:var(--muted); font-weight:900; font-size:12px; line-height:1.25; }
    .row{ display:flex; justify-content:space-between; align-items:center; gap:8px; }
    .buy{
      padding:9px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.08);
      color:var(--txt);
      font-weight:1000;
    }
    .buy:active{ transform: scale(.98); }
    .buy[disabled]{ opacity:.45; }
    .muted{ color:var(--muted); font-weight:900; }

    /* Floating +numbers */
    .float{
      position:fixed;
      font-weight:1000;
      pointer-events:none;
      text-shadow: 0 14px 40px rgba(0,0,0,.45);
      will-change: transform, opacity;
      z-index:30;
    }

    /* Bonus star */
    #bonus{
      position:fixed;
      width:72px; height:72px;
      border-radius: 18px;
      display:none;
      align-items:center; justify-content:center;
      background: linear-gradient(135deg, rgba(255,210,124,.95), rgba(255,90,122,.88));
      border:1px solid rgba(255,255,255,.18);
      box-shadow: 0 22px 80px rgba(0,0,0,.45), 0 0 45px rgba(255,210,124,.22);
      cursor:pointer;
      z-index:25;
      transform: translate(-50%, -50%);
    }
    #bonus:active{ transform: translate(-50%, -50%) scale(.98); }
    #bonus span{ font-size:34px; filter: drop-shadow(0 12px 30px rgba(0,0,0,.35)); }
  </style>
</head>
<body>
  <div id="toasts"></div>

  <div id="hud">
    <div class="pill"><span id="money">0</span> <small>Coins</small></div>
    <div style="display:flex; gap:10px;">
      <button class="btn" id="sound">üîä</button>
      <button class="btn" id="vibe">üì≥</button>
      <button class="btn" id="toggleShop">üõí</button>
    </div>
  </div>

  <div id="main">
    <div id="tapBtn" role="button" aria-label="Tippen um Coins zu bekommen">
      <div class="label">
        <div class="big">TIPPE!</div>
        <div class="small">+<span id="perClick">1</span> pro Tap</div>
      </div>
    </div>

    <div class="statsLine">
      <span><b id="cps">0</b> / Sek</span>
      <span>‚Ä¢</span>
      <span>Best: <b id="best">0</b></span>
      <span>‚Ä¢</span>
      <span>Level: <b id="lvl">1</b></span>
    </div>

    <div class="muted" style="text-align:center; max-width:560px; line-height:1.25;">
      Tippe f√ºr Coins. √ñffne den Shop unten (üõí) f√ºr Upgrades. ‚≠ê Bonus spawnt manchmal.
    </div>
  </div>

  <div id="bonus" title="Bonus! Tippen!"><span>‚≠ê</span></div>

  <div id="sheet" class="">
    <div id="sheetHeader">
      <div style="width:54px;"></div>
      <div id="handle"></div>
      <div style="width:54px;"></div>
    </div>
    <div id="sheetBody">
      <div style="display:flex; justify-content:space-between; align-items:baseline; gap:10px; margin-bottom:10px;">
        <div id="sheetTitle">üõí Upgrades</div>
        <div id="sheetHint">Tip: erst Auto-Click</div>
      </div>
      <div class="grid" id="shopGrid"></div>
    </div>
  </div>

<script>
(() => {
  "use strict";

  // ---------- utils ----------
  const clamp = (v,a,b)=>Math.max(a,Math.min(b,v));
  const fmt = (n) => {
    n = Math.floor(n);
    if (n < 1000) return ""+n;
    const units = ["K","M","B","T"];
    let u = -1, x = n;
    while (x >= 1000 && u < units.length-1){ x/=1000; u++; }
    return (x>=100 ? x.toFixed(0) : x>=10 ? x.toFixed(1) : x.toFixed(2)) + units[u];
  };
  const now = () => Date.now();
  const rnd = (a,b)=>a+Math.random()*(b-a);

  // ---------- DOM ----------
  const $money = document.getElementById("money");
  const $perClick = document.getElementById("perClick");
  const $cps = document.getElementById("cps");
  const $best = document.getElementById("best");
  const $lvl = document.getElementById("lvl");
  const $tapBtn = document.getElementById("tapBtn");
  const $shopGrid = document.getElementById("shopGrid");
  const $toasts = document.getElementById("toasts");
  const $sound = document.getElementById("sound");
  const $vibe = document.getElementById("vibe");
  const $toggleShop = document.getElementById("toggleShop");
  const $sheet = document.getElementById("sheet");
  const $handle = document.getElementById("handle");
  const $bonus = document.getElementById("bonus");

  // ---------- audio ----------
  let audioCtx = null;
  let soundOn = true;
  function beep(freq=520, dur=0.045, gain=0.06, type="triangle"){
    if (!soundOn) return;
    try{
      audioCtx = audioCtx || new (window.AudioContext || window.webkitAudioContext)();
      const t0 = audioCtx.currentTime;
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      o.type = type;
      o.frequency.setValueAtTime(freq, t0);
      g.gain.setValueAtTime(0.0001, t0);
      g.gain.exponentialRampToValueAtTime(gain, t0 + 0.01);
      g.gain.exponentialRampToValueAtTime(0.0001, t0 + dur);
      o.connect(g); g.connect(audioCtx.destination);
      o.start(t0); o.stop(t0 + dur + 0.02);
    }catch(_){}
  }

  // ---------- vibration ----------
  let vibeOn = true;
  const vibrate = (ms)=>{ if (vibeOn && navigator.vibrate) navigator.vibrate(ms); };

  // ---------- storage ----------
  const KEY = "tap_tycoon_sheet_v1";
  const load = () => { try { return JSON.parse(localStorage.getItem(KEY)||"{}"); } catch { return {}; } };
  const save = (obj) => localStorage.setItem(KEY, JSON.stringify(obj));

  // ---------- game data ----------
  const upgrades = [
    { id:"auto",  name:"Auto-Click", desc:"+0.5 / Sek", baseCost: 25,  cpsAdd: 0.5 },
    { id:"bot",   name:"Mini-Bot",   desc:"+2 / Sek",   baseCost: 120, cpsAdd: 2 },
    { id:"drone", name:"Drone",      desc:"+8 / Sek",   baseCost: 520, cpsAdd: 8 },
    { id:"lab",   name:"Labor",      desc:"+30 / Sek",  baseCost: 2400,cpsAdd: 30 },
    { id:"tower", name:"Tower",      desc:"+120 / Sek", baseCost: 12000,cpsAdd: 120 },
    { id:"core",  name:"Core",       desc:"+500 / Sek", baseCost: 65000,cpsAdd: 500 },
  ];

  const S = {
    coins: 0,
    best: 0,
    level: 1,
    perClick: 1,
    levelsBought: {},
    lastTick: now(),
    lastSave: now(),
    bonusActive: false,
    bonusHideT: 0
  };

  // ---------- init ----------
  const d = load();
  S.coins = Number(d.coins || 0);
  S.best  = Number(d.best  || 0);
  S.level = Number(d.level || 1);
  S.perClick = Number(d.perClick || 1);
  S.levelsBought = (d.levelsBought && typeof d.levelsBought === "object") ? d.levelsBought : {};
  soundOn = d.soundOn !== false;
  vibeOn  = d.vibeOn  !== false;
  S.lastTick = Number(d.lastTick || now());

  function getCps(){
    let cps = 0;
    for (const u of upgrades){
      const lvl = Number(S.levelsBought[u.id] || 0);
      cps += lvl * u.cpsAdd;
    }
    return cps;
  }

  // offline progress (max 6h)
  const offlineMs = clamp(now() - S.lastTick, 0, 1000*60*60*6);
  const offlineCoins = getCps() * (offlineMs/1000);
  if (offlineCoins >= 1) S.coins += offlineCoins;

  function costFor(u){
    const lvl = Number(S.levelsBought[u.id] || 0);
    return Math.floor(u.baseCost * Math.pow(1.18, lvl));
  }

  function toast(msg, sub=""){
    const el = document.createElement("div");
    el.className = "toast";
    el.innerHTML = sub ? `${msg} <small>${sub}</small>` : msg;
    $toasts.appendChild(el);
    setTimeout(()=>el.remove(), 1850);
  }

  function floatText(text, x, y){
    const el = document.createElement("div");
    el.className = "float";
    el.textContent = text;
    el.style.left = x + "px";
    el.style.top  = y + "px";
    el.style.opacity = "1";
    el.style.transform = "translate(-50%, -10px) scale(1)";
    el.style.fontSize = "18px";
    document.body.appendChild(el);

    const dx = rnd(-18, 18);
    const dy = rnd(-60, -90);
    const t0 = performance.now();
    const dur = 700;

    const step = (t)=>{
      const k = clamp((t - t0)/dur, 0, 1);
      el.style.opacity = String(1 - k);
      el.style.transform = `translate(calc(-50% + ${dx*k}px), ${dy*k}px) scale(${1 - k*0.15})`;
      if (k < 1) requestAnimationFrame(step);
      else el.remove();
    };
    requestAnimationFrame(step);
  }

  function updateDerived(){
    S.level = Math.max(1, Math.floor(Math.sqrt(S.best/120)) + 1);
    S.perClick = 1 + Math.floor((S.level-1) * 0.35);

    const cps = getCps();
    $money.textContent = fmt(S.coins);
    $perClick.textContent = fmt(S.perClick);
    $cps.textContent = fmt(cps);
    $best.textContent = fmt(S.best);
    $lvl.textContent = String(S.level);

    $sound.textContent = soundOn ? "üîä" : "üîá";
    $vibe.textContent  = vibeOn ? "üì≥" : "üö´";
  }

  function saveAll(){
    S.lastTick = now();
    save({
      coins: S.coins,
      best:  S.best,
      level: S.level,
      perClick: S.perClick,
      levelsBought: S.levelsBought,
      soundOn, vibeOn,
      lastTick: S.lastTick
    });
  }

  function buildShop(){
    $shopGrid.innerHTML = "";
    for (const u of upgrades){
      const lvl = Number(S.levelsBought[u.id] || 0);
      const cost = costFor(u);

      const card = document.createElement("div");
      card.className = "card";

      const name = document.createElement("div");
      name.className = "name";
      name.textContent = `${u.name}  (Lvl ${lvl})`;

      const desc = document.createElement("div");
      desc.className = "desc";
      desc.textContent = u.desc;

      const row = document.createElement("div");
      row.className = "row";

      const price = document.createElement("div");
      price.className = "muted";
      price.textContent = `Kosten: ${fmt(cost)}`;

      const buy = document.createElement("button");
      buy.className = "buy";
      buy.textContent = "Kaufen";
      buy.disabled = S.coins < cost;

      buy.addEventListener("click", () => {
        if (S.coins < cost) { toast("Zu wenig Coins"); vibrate(10); return; }
        S.coins -= cost;
        S.levelsBought[u.id] = lvl + 1;
        beep(680, 0.05, 0.06, "triangle");
        vibrate(12);
        toast("Upgrade gekauft!", `${u.name} ‚Üí Lvl ${lvl+1}`);
        updateDerived();
        buildShop();
        saveAll();
      });

      row.appendChild(price);
      row.appendChild(buy);

      card.appendChild(name);
      card.appendChild(desc);
      card.appendChild(row);

      $shopGrid.appendChild(card);
    }
  }

  function doTap(clientX, clientY){
    if (audioCtx && audioCtx.state === "suspended") audioCtx.resume().catch(()=>{});

    const gain = S.perClick;
    S.coins += gain;
    S.best = Math.max(S.best, S.coins);

    beep(520 + Math.min(700, gain*6), 0.035, 0.05, "triangle");
    vibrate(8);

    floatText("+" + fmt(gain), clientX, clientY);

    // small chance to spawn bonus star
    if (!S.bonusActive && Math.random() < 0.035){
      spawnBonus();
    }

    updateDerived();
    buildShop();
  }

  $tapBtn.addEventListener("pointerdown", (e) => {
    e.preventDefault();
    doTap(e.clientX, e.clientY);
  });

  // Bonus star
  function spawnBonus(){
    S.bonusActive = true;
    const x = rnd(60, innerWidth - 60);
    const y = rnd(140, innerHeight - 220);
    $bonus.style.display = "flex";
    $bonus.style.left = x + "px";
    $bonus.style.top  = y + "px";
    S.bonusHideT = now() + 5000;
    toast("‚≠ê BONUS!", "Tippe schnell!");
  }

  $bonus.addEventListener("pointerdown", (e) => {
    e.preventDefault();
    if (!S.bonusActive) return;

    const cps = getCps();
    const bonus = Math.max(10, Math.floor(15 + cps * 2.2 + S.level * 3));
    S.coins += bonus;
    S.best = Math.max(S.best, S.coins);

    beep(900, 0.07, 0.07, "sawtooth");
    vibrate(22);
    toast("BONUS geholt!", `+${fmt(bonus)} Coins`);

    S.bonusActive = false;
    $bonus.style.display = "none";

    updateDerived();
    buildShop();
    saveAll();
  });

  // settings
  $sound.addEventListener("click", () => {
    soundOn = !soundOn;
    toast(soundOn ? "Sound an" : "Sound aus");
    if (soundOn) beep(620, 0.04, 0.05, "triangle");
    updateDerived();
    saveAll();
  });
  $vibe.addEventListener("click", () => {
    vibeOn = !vibeOn;
    toast(vibeOn ? "Vibration an" : "Vibration aus");
    if (vibeOn) vibrate(15);
    updateDerived();
    saveAll();
  });

  // sheet toggle
  function toggleSheet(force){
    const open = (typeof force === "boolean") ? force : !$sheet.classList.contains("open");
    $sheet.classList.toggle("open", open);
    $toggleShop.textContent = open ? "‚¨áÔ∏è" : "üõí";
  }
  $toggleShop.addEventListener("click", () => { toggleSheet(); beep(560,0.04,0.05,"triangle"); });
  $handle.addEventListener("click", () => { toggleSheet(); beep(560,0.04,0.05,"triangle"); });

  // auto-open shop on very small screens so you notice it exists
  if (innerHeight < 700) toggleSheet(false);

  // tick loop
  let last = performance.now();
  function loop(t){
    const dt = Math.min(0.05, (t-last)/1000);
    last = t;

    const cps = getCps();
    if (cps > 0){
      S.coins += cps * dt;
      S.best = Math.max(S.best, S.coins);
    }

    if (S.bonusActive && now() > S.bonusHideT){
      S.bonusActive = false;
      $bonus.style.display = "none";
    }

    updateDerived();

    if (now() - S.lastSave > 4000){
      S.lastSave = now();
      saveAll();
    }

    requestAnimationFrame(loop);
  }

  // start
  if (offlineCoins >= 1) toast("Offline Coins", `+${fmt(offlineCoins)} (max 6h)`);
  updateDerived();
  buildShop();
  requestAnimationFrame(loop);
})();
</script>
</body>
</html>
